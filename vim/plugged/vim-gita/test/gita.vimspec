Describe gita
  Before
    Init
    let P = Import('System.Filepath')
  End

  Context #new([{expr}])
    Context A file buffer in a git repository
      Before
        WorkonInside
        let bufname = P.join(g:gita#test#inside, 'foo.txt')
        silent execute printf('new %s', bufname)
      End
      It should return a gita instance
        let gita = gita#new(bufname)
        Assert Equals(gita.enabled, 1)
        Assert Equals(gita.bufname, bufname(bufname))
        Assert Equals(gita.bufnum, bufnr(bufname))
        Assert Equals(gita.cwd, getcwd())
      End
      It should return a different gita instance
        let gita1 = gita#new(bufname)
        let gita2 = gita#new(bufname)
        Assert NotSame(gita1, gita2)
      End
    End

    Context A file buffer in a non git repository
      Before
        WorkonInside
        let bufname = P.join(g:gita#test#outside, 'foo.txt')
        silent execute printf('new %s', bufname)
      End
      It should return a gita instance while cwd is in a git repository
        let gita = gita#new(bufname)
        Assert Equals(gita.enabled, 1)
        Assert Equals(gita.bufname, bufname(bufname))
        Assert Equals(gita.bufnum, bufnr(bufname))
        Assert Equals(gita.cwd, getcwd())
      End
      It should return a gita instance but not enabled if cwd is not in a git repository
        WorkonOutside
        let gita = gita#new(bufname)
        Assert Equals(gita.enabled, 0)
        Assert Equals(gita.bufname, bufname(bufname))
        Assert Equals(gita.bufnum, bufnr(bufname))
        Assert Equals(gita.cwd, getcwd())
      End
      It should return a different gita instance always
        let gita1 = gita#new(bufname)
        let gita2 = gita#new(bufname)
        Assert NotSame(gita1, gita2)
      End
    End

    Context A non file buffer
      Before
        WorkonInside
        let bufname = 'non-file'
        silent execute printf('new %s', bufname)
        setlocal buftype=nofile
      End
      It should return a gita instance while cwd is in a git repository
        let gita = gita#new(bufname)
        Assert Equals(gita.enabled, 1)
        Assert Equals(gita.bufname, bufname(bufname))
        Assert Equals(gita.bufnum, bufnr(bufname))
        Assert Equals(gita.cwd, getcwd())
      End
      It should return a gita instance obut not enabled if cwd is not in a git repository
        WorkonOutside
        let gita = gita#new(bufname)
        Assert Equals(gita.enabled, 0)
        Assert Equals(gita.bufname, bufname(bufname))
        Assert Equals(gita.bufnum, bufnr(bufname))
        Assert Equals(gita.cwd, getcwd())
      End
    End
  End

  Context #get([{expr}])
    Context A file buffer in a git repository
      Before
        WorkonInside
        let bufname = P.join(g:gita#test#inside, 'foo.txt')
        silent execute printf('new %s', bufname)
      End
      It should return a gita instance
        let gita = gita#get(bufname)
        Assert Equals(gita.enabled, 1)
        Assert Equals(gita.bufname, bufname(bufname))
        Assert Equals(gita.bufnum, bufnr(bufname))
        Assert Equals(gita.cwd, getcwd())
      End
      It should return a same gita instance
        let gita1 = gita#get(bufname)
        let gita2 = gita#get(bufname)
        Assert Same(gita1, gita2)
      End
      It should not return a same gita instance if bufname has changed
        let gita1 = gita#get(bufname)
        silent execute printf('file %s', bufname . '.mod')
        let gita2 = gita#get(bufname . '.mod')
        Assert NotSame(gita1, gita2)
        Assert Equals(gita1.bufnum, gita2.bufnum)
      End
    End

    Context A file buffer in a non git repository
      Before
        WorkonInside
        let bufname = P.join(g:gita#test#outside, 'foo.txt')
        silent execute printf('new %s', bufname)
      End
      It should return a gita instance while cwd is in a git repository
        let gita = gita#get(bufname)
        Assert Equals(gita.enabled, 1)
        Assert Equals(gita.bufname, bufname(bufname))
        Assert Equals(gita.bufnum, bufnr(bufname))
        Assert Equals(gita.cwd, getcwd())
      End
      It should return a gita instance but not enabled if cwd is not in a git repository
        WorkonOutside
        let gita = gita#get(bufname)
        Assert Equals(gita.enabled, 0)
        Assert Equals(gita.bufname, bufname(bufname))
        Assert Equals(gita.bufnum, bufnr(bufname))
        Assert Equals(gita.cwd, getcwd())
      End
      It should return a same gita instance
        let gita1 = gita#get(bufname)
        let gita2 = gita#get(bufname)
        Assert Same(gita1, gita2)
      End
      It should not return a same gita instance if bufname has changed
        let gita1 = gita#get(bufname)
        silent execute printf('file %s', bufname . '.mod')
        let gita2 = gita#get(bufname . '.mod')
        Assert NotSame(gita1, gita2)
        Assert Equals(gita1.bufnum, gita2.bufnum)
      End
    End

    Context A non file buffer
      Before
        WorkonInside
        let bufname = 'non-file'
        silent execute printf('new %s', bufname)
        setlocal buftype=nofile
      End
      It should return a gita instance while cwd is in a git repository
        let gita = gita#get(bufname)
        Assert Equals(gita.enabled, 1)
        Assert Equals(gita.bufname, bufname(bufname))
        Assert Equals(gita.bufnum, bufnr(bufname))
        Assert Equals(gita.cwd, getcwd())
      End
      It should return a gita instance but not enabled if cwd is not in a git repository
        WorkonOutside
        let gita = gita#get(bufname)
        Assert Equals(gita.enabled, 0)
        Assert Equals(gita.bufname, bufname(bufname))
        Assert Equals(gita.bufnum, bufnr(bufname))
        Assert Equals(gita.cwd, getcwd())
      End
      It should return a same gita instance
        let gita1 = gita#get(bufname)
        let gita2 = gita#get(bufname)
        Assert Same(gita1, gita2)
      End
      It should not return a same gita instance if a current working directory has changed
        let gita1 = gita#get(bufname)
        WorkonOutside
        let gita2 = gita#get(bufname)
        Assert NotSame(gita1, gita2)
      End
    End
  End
End
